name: ğŸŒ KanjiTest Premium Platform - Build & Deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'data/**'
      - 'generator.py'
      - '.github/workflows/kanji-main.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'data/**'
      - 'generator.py'
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Deployment Environment'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging

permissions:
  contents: write
  pages: write
  id-token: write

# Allow only one deployment at a time
concurrency:
  group: "kanji-deployment"
  cancel-in-progress: false

jobs:
  # ============================================
  # JOB 1: Validate Data & Code Quality
  # ============================================
  validate:
    name: ğŸ” Validate Data & Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›°ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema

      - name: âœ… Validate JSON Data Structure
        run: |
          echo "ğŸ” Validating N5 Kanji Data..."
          python -c "
          import json
          import os
          
          json_path = 'data/n5/kanji/data.json'
          
          if not os.path.exists(json_path):
              print('âŒ Error: data.json not found!')
              exit(1)
          
          with open(json_path, 'r', encoding='utf-8') as f:
              data = json.load(f)
          
          # Validate structure
          assert 'kanji_set' in data, 'Missing kanji_set key'
          assert len(data['kanji_set']) > 0, 'Empty kanji_set'
          
          # Validate each kanji entry
          for idx, item in enumerate(data['kanji_set']):
              required_fields = ['kanji', 'meaning', 'romaji', 'onyomi', 'kunyomi', 'examples', 'slug']
              for field in required_fields:
                  assert field in item, f'Missing {field} in kanji #{idx}'
              
              # Validate examples
              assert len(item['examples']) > 0, f'No examples for {item[\"kanji\"]}'
              for ex in item['examples']:
                  assert 'japanese' in ex and 'romaji' in ex and 'english' in ex
          
          print(f'âœ… Validated {len(data[\"kanji_set\"])} kanji entries successfully!')
          "

      - name: ğŸ§ª Test Generator Syntax
        run: |
          python -m py_compile generator.py
          echo "âœ… Generator syntax is valid"

  # ============================================
  # JOB 2: Build Static Site
  # ============================================
  build:
    name: ğŸ—ï¸ Build Premium Kanji Platform
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: ğŸ›°ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install Production Dependencies
        run: |
          python -m pip install --upgrade pip
          # No external dependencies needed - pure Python!
          echo "âœ… Build environment ready"

      - name: ğŸ“‚ Verify Project Structure
        run: |
          echo "ğŸ“ Project Structure:"
          ls -lah
          echo ""
          echo "ğŸ“ Data Directory:"
          ls -lah data/n5/kanji/ || echo "âš ï¸ Data directory structure may need adjustment"

      - name: ğŸ¨ Execute Premium Kanji Generator
        run: |
          echo "ğŸš€ Starting build process..."
          python generator.py
          echo "âœ… Build completed successfully!"

      - name: ğŸ“Š Build Summary
        run: |
          echo "ğŸ“Š Build Statistics:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Count generated files
          html_count=$(find . -name "*.html" -type f | wc -l)
          echo "ğŸ“„ HTML Pages Generated: $html_count"
          
          # Check for key files
          [ -f "index.html" ] && echo "âœ… Landing page created" || echo "âŒ Landing page missing"
          [ -f "n5/index.html" ] && echo "âœ… N5 Hub created" || echo "âŒ N5 Hub missing"
          [ -f "sitemap.xml" ] && echo "âœ… Sitemap generated" || echo "âŒ Sitemap missing"
          
          # Count kanji pages
          kanji_pages=$(find n5/kanji -name "*.html" -type f 2>/dev/null | wc -l)
          echo "ğŸ“š Kanji Detail Pages: $kanji_pages"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ” Validate Generated Output
        run: |
          # Check if essential files exist
          if [ ! -f "index.html" ]; then
            echo "âŒ Error: Landing page not generated!"
            exit 1
          fi
          
          if [ ! -f "n5/index.html" ]; then
            echo "âŒ Error: N5 Hub not generated!"
            exit 1
          fi
          
          if [ ! -f "sitemap.xml" ]; then
            echo "âŒ Error: Sitemap not generated!"
            exit 1
          fi
          
          echo "âœ… All essential files validated"

      - name: ğŸ“¦ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kanji-platform-build
          path: |
            index.html
            sitemap.xml
            n5/
            data/
          retention-days: 7
          if-no-files-found: error

  # ============================================
  # JOB 3: Deploy to Production
  # ============================================
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://test.singhyogendra.com.np
    steps:
      - name: ğŸ›°ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: kanji-platform-build

      - name: ğŸ”§ Configure Git
        run: |
          git config --global user.name "KanjiTest AutoDeploy Bot"
          git config --global user.email "autodeploy@kanjitest.online"
          git config --global core.autocrlf false

      - name: ğŸ“Š Pre-Deployment Check
        run: |
          echo "ğŸ” Verifying deployment package..."
          
          # List what will be deployed
          echo "ğŸ“¦ Deployment Contents:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          ls -lah
          echo ""
          echo "ğŸ“ N5 Directory:"
          ls -lah n5/ 2>/dev/null || echo "âš ï¸ N5 directory not found"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸš€ Deploy to GitHub Pages Branch
        run: |
          # Stage all generated files
          git add -f index.html sitemap.xml n5/ data/
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes detected - skipping deployment"
            echo "DEPLOYMENT_STATUS=skipped" >> $GITHUB_ENV
          else
            # Create deployment commit
            git commit -m "ğŸš€ Deploy: Premium Kanji Platform [v$(date +%Y.%m.%d-%H%M)] [skip ci]

            ğŸ“Š Deployment Statistics:
            - Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            - Commit: ${{ github.sha }}
            - Triggered by: ${{ github.actor }}
            - Event: ${{ github.event_name }}
            
            ğŸ¯ Updates:
            - Generated static HTML pages with premium UI/UX
            - Updated sitemap.xml for SEO optimization
            - Enhanced glassmorphism design system
            - Improved accessibility and performance
            
            âœ¨ This is an automated deployment by KanjiTest CI/CD"
            
            # Push to main branch
            git push origin main
            
            echo "DEPLOYMENT_STATUS=success" >> $GITHUB_ENV
            echo "âœ… Deployment completed successfully!"
          fi

      - name: ğŸ“¢ Deployment Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ DEPLOYMENT SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“… Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”– Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸŒ Environment: Production"
          echo "ğŸ”— URL: https://test.singhyogendra.com.np"
          echo "ğŸ“Š Status: ${DEPLOYMENT_STATUS:-unknown}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ§¹ Cleanup Artifacts
        if: always()
        uses: geekyeggo/delete-artifact@v5
        with:
          name: kanji-platform-build
          failOnError: false

  # ============================================
  # JOB 4: Notify on Failure
  # ============================================
  notify-failure:
    name: ğŸ“§ Notify Deployment Failure
    runs-on: ubuntu-latest
    needs: [validate, build, deploy]
    if: failure()
    steps:
      - name: âš ï¸ Report Failure
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ DEPLOYMENT FAILED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“… Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”– Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸ“ Check the workflow logs for details"
          echo "ğŸ”— Workflow URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
